#include <stdio.h>
#include "./SDL2/SDL.h"
#include "./SDL2/SDL_image.h"

#undef main

int main(int argc, char* argv[]) {
    // 初始化SDL
    if (SDL_Init(SDL_INIT_VIDEO) != 0) {
        printf("SDL初始化失敗：%s\n", SDL_GetError());
        return 1;
    }

    // 創建窗口
    SDL_Window* window = SDL_CreateWindow("滑鼠移動", SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED, 800, 600, SDL_WINDOW_SHOWN);
    if (window == NULL) {
        printf("窗口創建失敗：%s\n", SDL_GetError());
        SDL_Quit();
        return 1;
    }

    // 創建渲染器
    SDL_Renderer* renderer = SDL_CreateRenderer(window, -1, 0);
    if (renderer == NULL) {
        printf("渲染器創建失敗：%s\n", SDL_GetError());
        SDL_DestroyWindow(window);
        SDL_Quit();
        return 1;
    }

    // 載入圖片
    SDL_Texture* texture = IMG_LoadTexture(renderer, "image.png");
    if (texture == NULL) {
        printf("圖片載入失敗：%s\n", SDL_GetError());
        SDL_DestroyRenderer(renderer);
        SDL_DestroyWindow(window);
        SDL_Quit();
        return 1;
    }

    // 獲取圖片寬度和高度
    int imageWidth, imageHeight;
    SDL_QueryTexture(texture, NULL, NULL, &imageWidth, &imageHeight);

    // 清空窗口
    SDL_RenderClear(renderer);

    // 事件循環
    SDL_Event event;
    int dragging = 0; // 標記是否正在拖動圖片
    int offsetX = 0;  // 圖片在滑鼠位置的偏移量
    int offsetY = 0;
    int imageX = 0;   // 圖片的當前位置
    int imageY = 0;

    while (1) {
        if (SDL_PollEvent(&event)) {
            if (event.type == SDL_QUIT) {
                break;
            }
            else if (event.type == SDL_MOUSEBUTTONDOWN) {
                if (event.button.button == SDL_BUTTON_LEFT) {
                    // 左鍵按下，啟動拖動
                    dragging = 1;
                    offsetX = event.button.x - imageX;
                    offsetY = event.button.y - imageY;
                }
            }
            else if (event.type == SDL_MOUSEBUTTONUP) {
                if (event.button.button == SDL_BUTTON_LEFT) {
                    // 左鍵放開，停止拖動
                    dragging = 0;
                }
            }
            else if (event.type == SDL_MOUSEMOTION) {
                if (dragging) {
                    // 更新圖片位置
                    imageX = event.motion.x - offsetX;
                    imageY = event.motion.y - offsetY;
                }
            }
        }

        // 清空窗口
        SDL_RenderClear(renderer);

        // 繪製圖片
        SDL_Rect destRect = {imageX, imageY, imageWidth, imageHeight};
        SDL_RenderCopy(renderer, texture, NULL, &destRect);

        // 更新渲染器
        SDL_RenderPresent(renderer);
    }

    // 清理資源
    SDL_DestroyTexture(texture);
    SDL_DestroyRenderer(renderer);
    SDL_DestroyWindow(window);
    SDL_Quit();

    return 0;
}
